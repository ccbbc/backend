**总体目标**
- 为“漂流瓶”玩法提供完整的后端服务：投递、钓取、回复、纪念册、捞回、善恶值计算、词库生成、反滥发与反滥收。
- 基于你的参考文档与现有后端，扩展成模块化、可维护、可观测的接口层与业务层。
- 整体修改原有代码，直到支持三大区域与复杂玩法逻辑。

**现状基线**
- 已有接口：
  - `GET /` 健康检查，`server.js:38-40`
  - `GET /bottles` 列表，`server.js:51-57`
  - `GET /bottles/:id` 详情，附带 `replies`，`server.js:59-69`
  - `POST /` 创建漂流瓶，含基础限流，`server.js:71-90`、`server.js:94-106`
- 存储：`sql.js` 内存数据库 + `drift.sqlite` 持久化，表 `bottles`/`replies`，`server.js:28-34`
- 已重构的限流行为：
  - 玩家当天 ≥5 次拒绝，`429` + `{error_code:201}`，`server.js:98-101`
  - 同 IP（不含当前作者）当天 ≥10 次拒绝，`429` + `{error_code:429}`，`server.js:104-106`

**功能清单**
- 钓瓶系统
  - 提供“钓取”接口，为玩家分配一个“未满5次回复、可钓取”的漂流瓶。
  - 分配后进入“临时区域”，限时 1 小时等待玩家回复或处理。
  - 受善恶值与瓶子种类影响的概率分布。
- 回复系统
  - 每瓶最多 5 次回复；达到 5 次时转入“纪念区”并发放纪念册。
  - 回复将内容追加到瓶的信件记录中，保留完整对话链路。
- 防滥发机制
  - 玩家每日 5 次；IP 每日 10 次；同角色或同 IP 2 分钟 CD；恶意请求封禁 1 小时。
  - 7 天未被回复的漂流瓶自动删除；达到 5 次回复的瓶永久保留;7天内被回复但未满5次的瓶到期进入纪念区。
- 防滥收机制
  - 玩家身上同时只能持有 1 个“他人漂流瓶”处于待处理状态（临时区域持有）。
  - 1 小时不回复则从临时区移除并回主区；玩家重投递时后端移除重复临时项。
- 三大区域
  - 主区域：所有投递聚合，7 天时效；过期无回复删除；有回复但未满 5 次者到期进入纪念区。
  - 临时区域：玩家钓取后暂存 1 小时；回复则迁移到主区域；超时自动回主区域。
  - 纪念区：达到 5 次回复或 7 天到期且曾被回复；永久保留；相关参与者可捞回纪念册。
- 捞瓶机制
  - 提供“捞回纪念册”接口，玩家可捞回作者或回复者和自己id相同的纪念册。
- 回复机制细化
  - 钓到瓶后可选择回复；回复完成后瓶传递到下一位钓取者；最大传递人数 5。
- 善恶值系统
  - 每玩家初始值 0，范围 [-50,50]。
  - 普通瓶 0；善意瓶 +1；恶意瓶 -5。
  - 影响瓶子祝福/诅咒判定与钓取概率：
    - 祝福/诅咒概率由善恶值分段加权：[-50,-20] 每点 +3% 诅咒概率；[-19,19] 每点 +2%；[20,50] 每点 +1% 祝福概率；整体概率限 0..100%。
- 漂流瓶瓶种类支持
  - 食物瓶（善意）
  - 乞丐瓶（恶意）
  - 富翁瓶（善意）
  - 宝藏瓶（善意）
  - 生物瓶（善意）
  - 天气瓶（恶意）
  - 整蛊瓶（恶意）
  - 挑战瓶（恶意）
- 命名规则
  - 发信状态：`{漂流瓶种类}·{祝福/诅咒/普通不显示}`
  - 收信状态：`{玩家名称}的{漂流瓶种类}·{祝福/诅咒/普通不显示}`

**数据模型建议**
- `players`：`id`, `name`, `morality`, `banned_until`
- `bottles`：
  - 核心：`id`, `sender_id`, `type`, `content`, `timestamp`, `ip`, `area`(`main|temp|memorial`), `status`, `reply_count`, `expires_at`, `bless_curse`(`bless|curse|none`), `name_send`, `name_recv`, `last_holder_id`
- `replies`：`id`, `bottle_id`, `user_id`, `content`, `timestamp`
- `holds`（临时区域持有）：`id`, `bottle_id`, `holder_id`, `held_at`, `expires_at`（1 小时）
- `daily_counters`：`date`, `player_id`, `ip`, `send_count`（玩家/IP 日累计）
- `cooldowns`：`key`(`player:<id>|ip:<addr>`), `until`
- `bans`：`key`, `reason`, `until`
- `memorials`：`bottle_id`, `participants[]`, `created_at`

**接口设计（建议）**
- 基础
  - `GET /` 健康检查（现有）
- 投递与词库
  - `POST /bottles` 客户端投递漂流瓶到后端；执行限流/CD/封禁判定
- 列表与详情
  - `GET /bottles` 支持按 `area`、`type`、`sender` 过滤分页
  - `GET /bottles/:id` 详情与回复（现有）
- 钓瓶与临时区
  - `POST /fish` 请求钓取；返回可钓瓶及效果预览；进入临时区并设置 1 小时 TTL
      - 返回字段新增 `item_id` (瓶子物品ID) 和 `status` (瓶子状态：normal/bless/curse)
    - `POST /holds/:id/consume` 玩家选择“查阅并消耗”；释放持有资格
  - `POST /holds/:id/release` 主动放弃；回主区
- 回复与传递
  - `POST /bottles/:id/reply` 追加回复；`reply_count == 5` 时转纪念区并发纪念册
- 纪念区与展示
  - `GET /memorials` 列表；支持按参与者过滤
- 捞瓶
  - `POST /bottles/:id/retrieve` 发送者捞回（优先 5 次回复瓶）；回滚相应善恶值；可重新编辑再投递
- 善恶值与概率
  - `GET /players/:id/morality` 查询
  - `POST /players/:id/morality/apply` 按瓶种类与祝福/诅咒结果调整
- 管理与反滥发/收
  - `GET /limits/check` 返回当前玩家与 IP 的限流状态（便于前端提示）
  - `POST /admin/ban`/`POST /admin/unban`（如需）
- 清理与调度
  - 计划任务（后端内部）：定时迁移与删除（7 天未回复删除；到期且已回复转纪念区；临时区超时回主区）

**流程设计**
- 流程设计
  - 投递
    - 检测并限流（玩家日 5、IP 日 10、CD 2 分钟、封禁 1 小时）
    - **先根据瓶子种类更新玩家善恶值** (善意瓶+1, 恶意瓶-5)
    - **后根据更新后的善恶值判定祝福/诅咒**（分段权重）
    - 入主区，设 7 天时效。
  - 钓取
    - 检查玩家是否持有临时瓶（防滥收）→ 候选集合：未满 5 次回复、未在临时持有 → 按善恶值与瓶类型概率加权抽取 → 临时区持有（1 小时）。
- 回复
  - 临时持有者回复 → 移出临时区 → 主区 `reply_count+1` → 达 5 次转纪念区并记录参与者；发纪念册。
- 过期与迁移
  - 主区 7 天未回复删除；主区有回复但未满 5 次在 7 天到期转纪念区。
  - 临时区 1 小时未回复回主区。
- 捞瓶
  - 发送者调用捞回：纪念区玩家参与过回复或信的作者是玩家自己

**限流与封禁算法**
- 玩家日计数：当日窗口 UTC+8 0 点刷新（已实现日窗口 `server.js:51-59`）。
- IP 日计数：同 IP（不含当前作者）当日累计（已实现 `server.js:67-71`、`server.js:102-106`）。
- CD：2 分钟窗口，维护 `cooldowns` 表；若违反并达到阈值（如 3 次/10 分钟），自动封禁 1 小时。
- 错误返回规范：
  - 玩家日超：`429` + `{error_code:201}`
  - IP 日超：`429` + `{error_code:202}`
  - CD 命中：`429` + `{error_code:301, retry_after:seconds}`
  - 封禁中：`403` + `{error_code:302, until:timestamp}`

**善恶值与概率**
- 祝福/诅咒判定：
  - 若 `morality >= 0`：祝福基线 `baseBless`, 增益系数按分段：`[0,19] 2%/点`，`[20,50] 1%/点`
  - 若 `morality < 0`：诅咒基线 `baseCurse`, 增益系数：`[-50,-20] 3%/点`，`[-19,-1] 2%/点`
  - 归一与裁剪：`blessChance = clamp(0..100)`，`curseChance = clamp(0..100)`，普通为剩余概率
- 钓取加权：
  - 正善恶值提高抽到“善意瓶”、“祝福瓶”的概率；负善恶值提高“恶意瓶”、“诅咒瓶”的概率；直至 100% 为上限。

**命名规则**
- 发信：后端根据瓶种类与祝福/诅咒结果生成 `name_send`。
- 收信：钓取时基于持有者生成 `name_recv`；在详情与展示中呈现。

**与模组的交互**
- 由模组发起 `POST /bottles`、`POST /fish`、`POST /bottles/:id/reply` 等接口。
- 结果回传后端以记录。

**实现计划（迭代建议）**
- 第 1 阶段：数据结构扩展（area/status/morality/effects/lexicon），完善限流与 CD/封禁。
- 第 2 阶段：钓瓶/临时区/回复/纪念区迁移与调度；实现 7 天与 1 小时定时任务。
- 第 3 阶段：善恶值算法与瓶种类效果返回；完成捞瓶与纪念册发放逻辑。
- 第 4 阶段：词库接口与后端内容生成；网站纪念展示（列表与详情）。
- 第 5 阶段：安全与观测（速率限制观察、封禁管理、日志与审计）。
